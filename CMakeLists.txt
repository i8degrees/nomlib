cmake_minimum_required ( VERSION 2.8 )

set ( PROJECT_VERSION_MAJOR 0 )
set ( PROJECT_VERSION_MINOR 1 )
set ( PROJECT_VERSION_PATCH 0 )

project ( gamelib ) # $PROJECT_NAME

set ( SRC_DIR "${PROJECT_SOURCE_DIR}/src" ) # gamelib/src
set ( EXAMPLES_SRC_DIR "${PROJECT_SOURCE_DIR}/examples" ) # gamelib/examples

configure_file  ( "${PROJECT_SOURCE_DIR}/cmake/version.hpp.in"
                  "${SRC_DIR}/version.hpp"
                )

#     CMake Environment
set ( CMAKE_VERBOSE_MAKEFILE true )
set ( CMAKE_BUILD_TYPE Debug )
set ( CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${PROJECT_SOURCE_DIR}/cmake/modules" )

option ( BUILD_SHARED_LIBS "Build as a shared library -- as opposed to static library" on )
option ( BUILD_UNIVERSAL_LIB "Build as OSX Universal Library; i386 and x86_64" off )

option ( BUILD_NOMLIB_EXAMPLES "Build nomlib usage examples" on )

# Creative OpenAL was a tad bit buggy for me on audio device destruction
# This is allegedly backwards-compatible with Creative OpenAL
option ( USE_OPENALSOFT_LIB "Use OpenAL-Soft library" on )

if ( BUILD_SHARED_LIBS )
  message ( "Building as a shared library" )
else ( NOT BUILD_SHARED_LIBS )
  message ( "Building as a static library" )
endif ( BUILD_SHARED_LIBS )

if ( BUILD_UNIVERSAL_LIB )
  set ( CMAKE_OSX_ARCHITECTURES i386; x86_64 )
  message ( "Building an OSX Universal Library" )
endif ( BUILD_UNIVERSAL_LIB )

if ( USE_OPENALSOFT_LIB )
  message ( "Building with OpenAL-Soft library" )
else ( NOT USE_OPENALSOFT_LIB )
  message ( "Building with OpenAL library" )
endif ( USE_OPENALSOFT_LIB )

if ( CMAKE_GENERATOR STREQUAL Xcode )
  message ( "Setting Xcode-specific project settings " )
  set ( CMAKE_XCODE_ATTRIBUTE_CLANG_CXX_LANGUAGE_STANDARD "c++11" )
  set ( CMAKE_XCODE_ATTRIBUTE_CLANG_CXX_LIBRARY "libc++" )
endif ( CMAKE_GENERATOR STREQUAL Xcode )

#     Platform specific
if ( NOT TTCARDS_NOMLIB_COMPILE ) # Ignore all this if TTcards is compiling us

  if ( CMAKE_SYSTEM_NAME STREQUAL Linux ) # Tested on Ubuntu v12.04-LTS(?) with
                                          # applicable dependencies installed
    message ( "Linux OS detected " )

    set ( CMAKE_CXX_COMPILER "/usr/bin/c++" )
    set ( CMAKE_CXX_FLAGS -std=c++0x )
  elseif ( CMAKE_SYSTEM_NAME STREQUAL Darwin )
    message ( "Darwin OS (Mac OSX) detected" )  # Developed 100% on OSX v10.8.3

    set ( CMAKE_CXX_COMPILER "/usr/bin/clang++" )
    set ( CMAKE_CXX_FLAGS "-std=c++11 -stdlib=libc++" )
  else () # Not Linux nor OSX
    message ( "Unsupported build system detected... Hopefully CMake gets it right for you; good luck!" )

  endif ( CMAKE_SYSTEM_NAME STREQUAL Linux )

endif ( NOT TTCARDS_NOMLIB_COMPILE )

set ( GAMELIB_SOURCE
      # audio
      ${SRC_DIR}/audio/AL/AudioDevice.cpp
      ${SRC_DIR}/audio/AL/Listener.cpp
      ${SRC_DIR}/audio/AL/SoundBuffer.cpp
      ${SRC_DIR}/audio/AL/SoundFile.cpp
      ${SRC_DIR}/audio/AL/SoundSource.cpp
      ${SRC_DIR}/audio/AL/Music.cpp
      ${SRC_DIR}/audio/AL/Sound.cpp
      # gfx
      ${SRC_DIR}/gfx/IDisplay.cpp
      ${SRC_DIR}/gfx/SDL_BitmapFont.cpp
      ${SRC_DIR}/gfx/SDL_Canvas.cpp
      ${SRC_DIR}/gfx/SDL_Display.cpp
      ${SRC_DIR}/gfx/SDL_Font.cpp
      ${SRC_DIR}/gfx/SDL_Gradient.cpp
      ${SRC_DIR}/gfx/SDL_Image.cpp
      ${SRC_DIR}/gfx/SDL_Line.cpp
      ${SRC_DIR}/gfx/SDL_Pixel.cpp
      ${SRC_DIR}/gfx/SDL_Rectangle.cpp
      ${SRC_DIR}/gfx/Sprite.cpp
      # sys
      ${SRC_DIR}/sys/FPS.cpp
      ${SRC_DIR}/sys/GameStates.cpp
      ${SRC_DIR}/sys/Logger.cpp
      ${SRC_DIR}/sys/ObjectCache.cpp
      ${SRC_DIR}/sys/OSXFS.cpp
      ${SRC_DIR}/sys/SDL_App.cpp
      ${SRC_DIR}/sys/SDL_Input.cpp
      ${SRC_DIR}/sys/SDL_Timer.cpp
      # math
      ${SRC_DIR}/math/Color.cpp
      ${SRC_DIR}/math/Coords.cpp
      ${SRC_DIR}/math/Transformable.cpp
      ${SRC_DIR}/math/Vector2-inl.hpp
      ${SRC_DIR}/math/Vector3-inl.hpp
      ${SRC_DIR}/math/Vector4-inl.hpp
      # gui
      ${SRC_DIR}/gui/SDL_Cursor.cpp
      ${SRC_DIR}/gui/SDL_MessageBox.cpp
      # sdl
      ${SRC_DIR}/sdl/utils.cpp
    )

set ( GAMELIB_HEADERS_ROOT
      ${SRC_DIR}/config.hpp
      ${SRC_DIR}/types.hpp
      ${SRC_DIR}/audio.hpp
      ${SRC_DIR}/graphics.hpp
      ${SRC_DIR}/gui.hpp
      ${SRC_DIR}/math.hpp
      ${SRC_DIR}/system.hpp
      # auto-generated by CMake:
      ${SRC_DIR}/version.hpp
    )

set ( GAMELIB_HEADERS_AUDIO
      ${SRC_DIR}/audio/AL/AudioDevice.hpp
      ${SRC_DIR}/audio/AL/Listener.hpp
      ${SRC_DIR}/audio/AL/SoundBuffer.hpp
      ${SRC_DIR}/audio/AL/SoundFile.hpp
      ${SRC_DIR}/audio/AL/SoundSource.hpp
      ${SRC_DIR}/audio/AL/Music.hpp
      ${SRC_DIR}/audio/AL/Sound.hpp
    )

set ( GAMELIB_HEADERS_GFX
      ${SRC_DIR}/gfx/SDL_Font.hpp
      ${SRC_DIR}/gfx/SDL_Gradient.hpp
      ${SRC_DIR}/gfx/SDL_BitmapFont.hpp
      ${SRC_DIR}/gfx/IDrawable.hpp
      ${SRC_DIR}/gfx/SDL_Drawable.hpp
      ${SRC_DIR}/gfx/SDL_Image.hpp
      ${SRC_DIR}/gfx/SDL_Pixel.hpp
      ${SRC_DIR}/gfx/SDL_Line.hpp
      ${SRC_DIR}/gfx/SDL_Rectangle.hpp
      ${SRC_DIR}/gfx/SDL_Canvas.hpp
      ${SRC_DIR}/gfx/IDisplay.hpp
      ${SRC_DIR}/gfx/SDL_Display.hpp
      ${SRC_DIR}/gfx/Sprite.hpp
    )

set ( GAMELIB_HEADERS_SYS
      ${SRC_DIR}/sys/FPS.hpp
      ${SRC_DIR}/sys/GameStates.hpp
      ${SRC_DIR}/sys/IState.hpp
      ${SRC_DIR}/sys/Logger.hpp
      ${SRC_DIR}/sys/ObjectCache.hpp
      ${SRC_DIR}/sys/OSXFS.hpp
      ${SRC_DIR}/sys/SDL_App.hpp
      ${SRC_DIR}/sys/SDL_Input.hpp
      ${SRC_DIR}/sys/SDL_Timer.hpp
    )

set ( GAMELIB_HEADERS_MATH
      ${SRC_DIR}/math/Color.hpp
      ${SRC_DIR}/math/Coords.hpp
      ${SRC_DIR}/math/Transformable.hpp
      ${SRC_DIR}/math/Vector2-inl.hpp
      ${SRC_DIR}/math/Vector3-inl.hpp
      ${SRC_DIR}/math/Vector4-inl.hpp
    )

set ( GAMELIB_HEADERS_GUI
      ${SRC_DIR}/gui/SDL_Cursor.hpp
      ${SRC_DIR}/gui/SDL_MessageBox.hpp
    )

set ( GAMELIB_HEADERS_SDL
      ${SRC_DIR}/sdl/utils.hpp
    )

#     Project Header Files
include_directories ( src )

#     Required Dependencies
find_package ( SDL REQUIRED )
include_directories ( ${SDL_INCLUDE_DIR} )
set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${SDL_LIBRARY} )

find_package ( SDL_image REQUIRED )
include_directories ( ${SDL_IMAGE_INCLUDE_DIR} )
set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${SDLIMAGE_LIBRARY} )

find_package ( SDL_ttf REQUIRED )
include_directories ( ${SDL_TTF_INCLUDE_DIR} )
set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${SDLTTF_LIBRARY} )

if ( USE_OPENALSOFT_LIB )
  find_package ( OpenALSoft REQUIRED )
  include_directories ( ${OPENALSOFT_INCLUDE_DIR} )
  set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${OPENALSOFT_LIBRARY} )
else ( NOT USE_OPENALSOFT_LIB )
  find_package ( OpenAL REQUIRED )
  include_directories ( ${OPENAL_INCLUDE_DIR} )
  set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${OPENAL_LIBRARY} )
endif ( USE_OPENALSOFT_LIB )

find_package ( libsndfile REQUIRED )
include_directories ( ${LIBSNDFILE_INCLUDE_DIR} )
set ( REQUIRED_LIBS ${REQUIRED_LIBS} ${LIBSNDFILE_LIBRARY} )

link_libraries  ( ${PROJECT_NAME} ${REQUIRED_LIBS} )

if ( NOT BUILD_SHARED_LIBS )
  add_library ( ${PROJECT_NAME} STATIC ${GAMELIB_SOURCE} )
else ( BUILD_SHARED_LIBS )
  add_library ( ${PROJECT_NAME} SHARED ${GAMELIB_SOURCE} )
endif ( NOT BUILD_SHARED_LIBS )

set_target_properties ( ${PROJECT_NAME} # makefile target
                        PROPERTIES SOVERSION "${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}"
                      )

#     FIXME: doxygen docs generation
add_custom_target ( nomlib-docs
                    COMMAND ${DOXYGEN_COMMAND} ${DOXYGEN_CONFIG_FILE}
                  )

if ( NOT TTCARDS_NOMLIB_COMPILE )

  #     Install library
  if ( BUILD_SHARED_LIBS )
    install ( TARGETS ${PROJECT_NAME} LIBRARY DESTINATION lib )
  else ( NOT BUILD_SHARED_LIBS )
    install ( TARGETS ${PROJECT_NAME} ARCHIVE DESTINATION lib )
  endif ( BUILD_SHARED_LIBS )

  #     Install headers
  install ( FILES ${GAMELIB_HEADERS_ROOT} DESTINATION include/nomlib )
  install ( FILES ${GAMELIB_HEADERS_AUDIO} DESTINATION include/nomlib/audio/AL )
  install ( FILES ${GAMELIB_HEADERS_GFX} DESTINATION include/nomlib/gfx )
  install ( FILES ${GAMELIB_HEADERS_SYS} DESTINATION include/nomlib/sys )
  install ( FILES ${GAMELIB_HEADERS_MATH} DESTINATION include/nomlib/math )
  install ( FILES ${GAMELIB_HEADERS_GUI} DESTINATION include/nomlib/gui )
  install ( FILES ${GAMELIB_HEADERS_SDL} DESTINATION include/nomlib/sdl )

  #     Uninstall target
  configure_file  (
                    "${PROJECT_SOURCE_DIR}/cmake/cmake_uninstall.cmake.in"
                    "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake"
                    IMMEDIATE @ONLY
                  )

  add_custom_target ( uninstall
                      COMMAND ${CMAKE_COMMAND} -P
                      ${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake
                    )

endif ( NOT TTCARDS_NOMLIB_COMPILE )

if ( BUILD_NOMLIB_EXAMPLES )
  set ( EXECUTABLE_OUTPUT_PATH "${EXAMPLES_SRC_DIR}" )
  set ( NOMLIB_EXAMPLES_AUDIO
        ${EXAMPLES_SRC_DIR}/audio/audio.cpp
      )
  set ( NOMLIB_EXAMPLES_APP
        ${EXAMPLES_SRC_DIR}/app/app.cpp
      )
  link_libraries ( gamelib SDLmain )
  add_executable ( audio/audio ${NOMLIB_EXAMPLES_AUDIO} )
  add_executable ( app/app ${NOMLIB_EXAMPLES_APP} )
endif ( BUILD_NOMLIB_EXAMPLES )
